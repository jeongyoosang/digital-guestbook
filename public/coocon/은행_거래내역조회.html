<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>은행 거래내역 조회</title>

    <!-- ✅ 쿠콘 원본 스타일 -->
    <link rel="stylesheet" href="/coocon/css/process_manager.css" />

    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Noto Sans KR", "Apple SD Gothic Neo", "Malgun Gothic", Arial,
          sans-serif;
        margin: 0;
        background: #f6f7fb;
      }
      .wrap {
        max-width: 920px;
        margin: 0 auto;
        padding: 28px 16px 60px;
      }
      .card {
        background: #fff;
        border-radius: 18px;
        border: 1px solid #eef0f6;
        box-shadow: 0 10px 30px rgba(20, 20, 43, 0.06);
        overflow: hidden;
      }
      .hd {
        padding: 20px 22px;
        border-bottom: 1px solid #eef0f6;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .title {
        font-size: 18px;
        font-weight: 800;
        letter-spacing: -0.02em;
      }
      .sub {
        font-size: 12px;
        color: #667085;
        margin-top: 4px;
      }
      .bd {
        padding: 20px 22px;
      }
      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 12px;
      }
      .field label {
        display: block;
        font-size: 12px;
        color: #667085;
        margin-bottom: 6px;
        font-weight: 600;
      }
      .field input,
      .field select {
        width: 100%;
        box-sizing: border-box;
        border: 1px solid #e4e7ec;
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 14px;
        outline: none;
        background: #fff;
      }
      .actions {
        display: flex;
        gap: 10px;
        margin-top: 16px;
      }
      .btn {
        flex: 1;
        border: 1px solid #e4e7ec;
        background: #fff;
        border-radius: 12px;
        padding: 12px 14px;
        font-size: 14px;
        font-weight: 800;
        cursor: pointer;
      }
      .btn.primary {
        background: #111827;
        color: #fff;
        border-color: #111827;
      }
      .btn:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }
      .log {
        margin-top: 14px;
        background: #0b1220;
        color: #d1e9ff;
        border-radius: 12px;
        padding: 12px;
        font-size: 12px;
        line-height: 1.5;
        white-space: pre-wrap;
        word-break: break-word;
        max-height: 220px;
        overflow: auto;
      }
      .note {
        margin-top: 10px;
        font-size: 12px;
        color: #667085;
      }
      .warn {
        margin-top: 10px;
        font-size: 12px;
        color: #b42318;
        background: #fffbfa;
        border: 1px solid #fecdca;
        padding: 10px 12px;
        border-radius: 12px;
        display: none;
      }

      /* ✅ cert manager layer container */
      #certLayer {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        z-index: 9999;
      }
    </style>

    <!-- ✅ 쿠콘 원본 의존성 (순서 매우 중요) -->
    <script src="/coocon/js/jquery-1.9.1.min.js"></script>
    <script src="/coocon/js/json2.js"></script>
    <script src="/coocon/js/web_socket.js"></script>
    <script src="/coocon/js/isasscaping.js"></script>
  </head>

  <body>
    <div class="wrap">
      <div class="card">
        <div class="hd">
          <div>
            <div class="title">은행 거래내역 조회</div>
            <div class="sub">
              인증서 선택 → 연결 완료 시 자동으로 원래 화면으로 돌아갑니다.
            </div>
          </div>
          <button class="btn" id="btnClose" style="max-width: 120px">
            닫기
          </button>
        </div>

        <div class="bd">
          <div class="note">
            ✅ 현재 페이지는 쿠콘 NX 모듈 기반 인증서 선택 UI를 실행합니다.
            <br />
            ✅ “인증서 목록이 비어 있음”이면 아래 로그를 캡처해서 바로 원인
            잡습니다.
          </div>

          <div class="warn" id="warnBox"></div>

          <div class="row">
            <div class="field">
              <label>eventId</label>
              <input id="eventId" type="text" readonly />
            </div>
            <div class="field">
              <label>scrapeAccountId</label>
              <input id="scrapeAccountId" type="text" readonly />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>은행 코드 (bankCode)</label>
              <input
                id="bankCode"
                type="text"
                placeholder="예) 088 (신한), 004 (국민) 등"
              />
            </div>
            <div class="field">
              <label>은행명 (bankName)</label>
              <input id="bankName" type="text" placeholder="예) 신한은행" />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>계좌 마스킹 (accountMasked)</label>
              <input
                id="accountMasked"
                type="text"
                placeholder="예) 110-***-123456"
              />
            </div>
            <div class="field">
              <label>모드</label>
              <select id="mode">
                <option value="real" selected>real</option>
                <option value="stub">stub</option>
              </select>
            </div>
          </div>

          <div class="actions">
            <button class="btn primary" id="btnInit">
              1) 모듈 초기화 + 인증서 선택
            </button>
            <button class="btn" id="btnFinish" disabled>
              2) 연결 완료(React로 전달)
            </button>
          </div>

          <div class="log" id="log"></div>
        </div>
      </div>
    </div>

    <!-- ✅ 쿠콘 인증서 팝업 레이어 (원본 플러그인 사용) -->
    <div id="certLayer"></div>

    <script>
      (function () {
        function qs(k) {
          var u = new URL(location.href);
          return u.searchParams.get(k);
        }

        function log(msg) {
          var el = document.getElementById("log");
          var t =
            "[" +
            new Date().toLocaleTimeString() +
            "] " +
            (typeof msg === "string" ? msg : JSON.stringify(msg));
          el.textContent += t + "\n";
          el.scrollTop = el.scrollHeight;
        }

        function warn(msg) {
          var box = document.getElementById("warnBox");
          box.style.display = "block";
          box.textContent = msg;
        }

        function safePostToOpener(payload) {
          if (!window.opener) {
            warn("opener(원래 페이지)가 없습니다. 팝업이 아닌 방식으로 열렸을 수 있어요.");
            return false;
          }
          try {
            window.opener.postMessage(payload, "*");
            return true;
          } catch (e) {
            console.error(e);
            warn("postMessage 실패: " + (e && e.message ? e.message : e));
            return false;
          }
        }

        // ====== Params ======
        var eventId = qs("eventId") || "";
        var scrapeAccountId = qs("scrapeAccountId") || "";

        document.getElementById("eventId").value = eventId;
        document.getElementById("scrapeAccountId").value = scrapeAccountId;

        // ====== UI ======
        document.getElementById("btnClose").addEventListener("click", function () {
          window.close();
        });

        var btnInit = document.getElementById("btnInit");
        var btnFinish = document.getElementById("btnFinish");

        // ====== Guard ======
        if (!eventId || !scrapeAccountId) {
          warn("필수 파라미터 누락: eventId / scrapeAccountId");
          log({ eventId: eventId, scrapeAccountId: scrapeAccountId });
        }

        // ====== NX ======
        // isasscaping.js에서 생성된 전역 CooconiSASNX 사용
        var nx = window.CooconiSASNX;

        if (!nx) {
          warn("CooconiSASNX가 없습니다. /coocon/js/isasscaping.js 로드 실패");
        }

        function openCertPopupAndWait(done) {
          // cert manager 플러그인: $('#certLayer').makeCertManager(callback)
          $("#certLayer").makeCertManager(function (certInfo) {
            log("✅ 인증서 선택 완료");
            log(certInfo);

            // 여기서 certInfo를 기반으로 실제 scraping job을 실행하는 원본 흐름이 보통 붙음.
            // 지금은 “연결 완료 신호”를 React로 전달하는 게 1차 목표.
            if (typeof done === "function") done(certInfo);
          });
        }

        btnInit.addEventListener("click", function () {
          try {
            if (!nx) return;

            btnInit.disabled = true;
            log("1) nx.init() 호출... (모듈 버전 체크 + 실행 + 소켓 연결)");

            nx.init(function (ok) {
              log("nx.init 결과: " + ok);

              if (!ok) {
                warn(
                  "모듈 초기화 실패. (설치/실행/권한/UAC/차단 가능)\n로그를 캡처해서 공유해줘."
                );
                btnInit.disabled = false;
                return;
              }

              log("2) nx.open(1) 호출...");
              nx.open(1, function (openMsg) {
                log("nx.open 응답:");
                log(openMsg);

                log("3) 인증서 목록 UI 오픈 (makeCertManager)...");
                openCertPopupAndWait(function () {
                  // 인증서까지 선택 완료되면 Finish 버튼 활성화
                  btnFinish.disabled = false;
                  btnInit.disabled = false;
                  log("✅ 다음: '연결 완료' 버튼을 눌러 React로 전달");
                });
              });
            });
          } catch (e) {
            console.error(e);
            warn("예외 발생: " + (e && e.message ? e.message : e));
            btnInit.disabled = false;
          }
        });

        btnFinish.addEventListener("click", function () {
          var bankCode = (document.getElementById("bankCode").value || "").trim();
          var bankName = (document.getElementById("bankName").value || "").trim();
          var accountMasked = (document.getElementById("accountMasked").value || "").trim();
          var mode = document.getElementById("mode").value || "real";

          if (!bankCode || !accountMasked) {
            warn("bankCode / accountMasked 는 필수입니다.");
            return;
          }

          var payload = {
            type: "COOCON_FINISH",
            eventId: eventId,
            scrapeAccountId: scrapeAccountId,
            bankCode: bankCode,
            bankName: bankName || null,
            accountMasked: accountMasked,
            mode: mode,
          };

          log("postMessage 전송:");
          log(payload);

          var ok = safePostToOpener(payload);
          if (ok) {
            try {
              window.close();
            } catch (e) {}
          }
        });

        log("페이지 로드 완료");
        log("eventId=" + eventId);
        log("scrapeAccountId=" + scrapeAccountId);
      })();
    </script>
  </body>
</html>
