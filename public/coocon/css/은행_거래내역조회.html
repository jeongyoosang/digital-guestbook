<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Expires" content="-1">
  <meta http-equiv="Cache-Control" content="No-Cache" />
  <meta http-equiv="Pragma" content="No-Cache" />

  <script src="../jquery-1.9.1.min.js"></script>
  <script src="../json2.js"></script>
  <script src="../web_socket.js"></script>
  <script src="../isasscaping.js"></script>

  <link rel="stylesheet" href="/coocon/css/process_manager.css" />

  <style type="text/css">
    html, body { margin:0; padding:0; background:#fff; }
    .header_wrap{display:block;height:21px;margin:0;padding:12px 0 12px 20px;border-bottom:1px solid #333;background-color:#fff;}
    .header_wrap .tit_h1{display:block;height:21px;padding-left:29px;font-size:16px;color:#000;line-height:24px;*line-height:22px;background-image:url(./img/bg/bg_logo.png);background-repeat:no-repeat;background-position:0 0;}
    .content_wrap{position:relative;padding:23px 25px 81px 25px;min-width:1024px;}
    .tbl_lst {table-layout:fixed;margin:0;width:100%;border-top:1px solid #d2d2d2;border-right:1px solid #d2d2d2;}
    .tbl_lst th{border-bottom:1px solid #d2d2d2;border-left:1px solid #d2d2d2;background-color:#f6f6f6;}
    .tbl_lst th > div{padding:2px 0 0;*padding:1px 0;color:#333;font-weight:normal;line-height:29px;}
    .tbl_lst td{vertical-align:top;border-bottom:1px solid #d2d2d2;border-left:1px solid #d2d2d2;}
    .tbl_lst td > div{padding:2px 8px 0;*padding:1px 8px;color:#555;font-weight:normal;text-align:left;line-height:29px !important;}
    .tit_box{margin-top:12px;}
    .tar{text-align:right;}
    .btn_srch{display:inline-block;padding:10px 14px;border:1px solid #333;border-radius:8px;text-decoration:none;color:#000;background:#fff;}
    .btn_srch:hover{background:#f2f2f2;}
    .hint{font-size:12px;color:#666;margin-top:8px;}
  </style>

  <script type="text/javascript">
    function getSAS() {
      return window.CooconSAS || window.cooconSAS || window.nx || window.NX || window.CooconiSASNX || null;
    }

    function safeGetCertList(sas, cb) {
      var fn = sas && (sas.getCertList || sas.getCertlist || sas.getCerts);
      if (!fn) return cb(null);
      try { fn.call(sas, cb); } catch (e) { cb(null); }
    }

    function safeInit(sas, cb) {
      var fn = sas && sas.init;
      if (!fn) return cb(true);
      try { fn.call(sas, cb); } catch (e) { cb(false); }
    }

    function renderCertList(rtn) {
      $('#cert_list').empty();
      $("#cert_list").append('<option value="" >인증서를 선택하세요.</option>');

      if (!rtn || !rtn.Result) return;

      var cert = rtn.Result.CertList;
      if (!cert || !cert.length) return;

      $.each(cert, function (i, v) {
        var user = v['User'] || '';
        var exp = v['ExpiryDate'] || '';
        var label = (exp ? (exp + ' ') : '') + user;
        $("#cert_list").append(
          '<option data=\'' + JSON.stringify(v) + '\'>' + label + '</option>'
        );
      });
    }

    function bootCertList() {
      var start = Date.now();
      var timer = setInterval(function () {
        var sas = getSAS();
        if (!sas) {
          if (Date.now() - start > 8000) {
            clearInterval(timer);
            console.log("[COOCON][HTML] CooconSAS/nx not found (timeout)");
          }
          return;
        }

        clearInterval(timer);

        safeInit(sas, function (ok) {
          console.log("[COOCON][HTML] init =", ok);
          if (!ok) return;

          safeGetCertList(sas, function (rtn) {
            console.log("[COOCON][HTML] getCertList rtn =", rtn);
            renderCertList(rtn);
          });
        });
      }, 200);
    }

    function buildCertMeta() {
      var cert_data = $("#cert_list option:selected").attr("data");
      var cert_nm = "";
      var raw = null;
      if(cert_data){
        try{
          raw = JSON.parse(cert_data);
          cert_nm = raw['RDN'] || "";
        }catch(e){}
      }

      if(cert_nm === ""){
        alert('인증서를 선택하세요.');
        return null;
      }
      if($("#cert_pwd").val() === ""){
        alert('인증서 비밀번호를 입력하세요.');
        return null;
      }
      if($("#jumin_no").val() === ""){
        alert('주민번호를 입력하세요.');
        return null;
      }

      var gigwan = $("#gigwan option:selected").val();
      if(gigwan === ""){
        alert('금융기관을 선택하세요.');
        return null;
      }

      return {
        cert_rdn: cert_nm,
        cert_pwd: $("#cert_pwd").val(),
        jumin_no: $("#jumin_no").val(),
        bank_code: gigwan,
        raw_cert: raw
      };
    }

    // ✅ iframe -> parent 로 인증 meta 전달
    function doneCert() {
      var meta = buildCertMeta();
      if (!meta) return;
      try {
        parent.postMessage({ type: "COOCON_CERT_META", payload: meta }, "*");
      } catch (e) {
        alert("부모창 전달 실패: " + (e && e.message ? e.message : e));
      }
    }

    function cancelCert() {
      try {
        parent.postMessage({ type: "COOCON_CERT_CANCEL" }, "*");
      } catch (e) {}
    }

    $(document).ready(function () {
      bootCertList();
    });
  </script>
</head>

<body>
  <div class="wrap">
    <div class="header_wrap">
      <div class="f_left">
        <h1 class="tit_h1">금융기관-계좌조회</h1>
      </div>
    </div>

    <div class="content_wrap">
      <div class="tbl_lst">
        <table summary="">
          <colgroup>
            <col style="width: 120px;">
            <col/>
            <col style="width: 120px;">
            <col/>
            <col style="width: 66px;">
          </colgroup>
          <tbody>
            <tr><th colspan="5"><div>금융기관-계좌조회</div></th></tr>

            <tr>
              <th><div>인증서 명<span class="txt_r"> *</span></div></th>
              <td><div><select id="cert_list"><option value="">인증서를 선택하세요.</option></select></div></td>
              <th><div>인증서 비밀번호<span class="txt_r"> *</span></div></th>
              <td colspan="2"><div><input type="password" id="cert_pwd" placeholder="인증서 비밀번호" value="" /></div></td>
            </tr>

            <tr>
              <th><div>금융기관<span class="txt_r"> *</span></div></th>
              <td colspan="2">
                <div>
                  <select id="gigwan">
                    <option value="" >금융기관을 선택하세요.</option>
                    <option value="kdb">산업은행</option>
                    <option value="ibk">기업은행</option>
                    <option value="kbstar">국민은행</option>
                    <option value="hanabank">KEB하나은행</option>
                    <option value="suhyupbank">수협중앙회</option>
                    <option value="nonghyup">농협은행</option>
                    <option value="jejubank">제주은행</option>
                    <option value="jbbank">전북은행</option>
                    <option value="knbank">경남은행</option>
                    <option value="shinhan">신한은행</option>
                    <option value="wooribank">우리은행</option>
                    <option value="standardchartered">SC은행</option>
                    <option value="citibank">한국씨티은행</option>
                    <option value="dgb">대구은행</option>
                    <option value="busanbank">부산은행</option>
                    <option value="kjbank">광주은행</option>
                    <option value="kfcc">새마을금고중앙회</option>
                    <option value="cu">신협중앙회</option>
                    <option value="epostbank">우체국</option>
                  </select>
                </div>
              </td>
              <th><div>주민번호<span class="txt_r"> *</span></div></th>
              <td><div><input type="text" id="jumin_no" placeholder="주민번호(숫자만)" value="" /></div></td>
            </tr>
          </tbody>
        </table>

        <div class="tit_box tar">
          <a class="btn_srch" href="javascript:doneCert()"><span>인증 완료</span></a>
          <a class="btn_srch" style="margin-left:8px" href="javascript:cancelCert()"><span>닫기</span></a>
          <div class="hint">※ 인증 완료를 누르면 부모 페이지에서 스크래핑을 진행합니다.</div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
