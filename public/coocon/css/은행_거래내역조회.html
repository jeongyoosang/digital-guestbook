<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Expires" content="-1">
  <meta http-equiv="Cache-Control" content="No-Cache" />
  <meta http-equiv="Pragma" content="No-Cache" />

  <!-- 필수 라이브러리 -->
  <script src="../jquery-1.9.1.min.js"></script>
  <script src="../json2.js"></script>
  <script src="../web_socket.js"></script>
  <script src="../isasscaping.js"></script>

  <link rel="stylesheet" href="/coocon/css/process_manager.css" />

  <style type="text/css">
    .header_wrap{display:block;height:21px;margin:0;padding:12px 0 12px 20px;border-bottom:1px solid #333;background-color:#fff;}
    .header_wrap .tit_h1{display:block;height:21px;padding-left:29px;font-size:16px;color:#000;line-height:24px;background-image:url(./img/bg/bg_logo.png);background-repeat:no-repeat;background-position:0 0;}
    .content_wrap{position:relative;padding:23px 25px 81px 25px;min-width:1024px;}
    .tbl_lst {width:100%;border-top:1px solid #d2d2d2;border-right:1px solid #d2d2d2;}
    .tbl_lst th, .tbl_lst td{border-bottom:1px solid #d2d2d2;border-left:1px solid #d2d2d2;}
    .tbl_lst th{background:#f6f6f6;}
    .tbl_lst th > div{line-height:29px;}
    .tbl_lst td > div{padding:2px 8px;line-height:29px;}
    .footer{width:100%;position:fixed;bottom:0;left:0;}
  </style>

  <script type="text/javascript">
    var nx = null;

    /** 초기화 */
    $(document).ready(function () {
      nx = window.CooconiSASNX;
      if (!nx) {
        alert("쿠콘 NX 모듈이 로드되지 않았습니다.");
        return;
      }

      nx.init(function (ok) {
        if (!ok) {
          alert("쿠콘 모듈 초기화 실패");
          return;
        }

        // 인증서 목록 조회
        nx.getCertList(function (list) {
          $("#cert_list").empty().append('<option value="">인증서를 선택하세요.</option>');
          if (!list || !list.length) return;

          for (var i = 0; i < list.length; i++) {
            var c = list[i];
            $("#cert_list").append(
              '<option data=\'' + JSON.stringify(c) + '\'>' +
              (c.ExpiryDate || "") + " " + (c.User || "") +
              '</option>'
            );
          }
        });
      });
    });

    /** 거래내역 조회 */
    function doScrape() {
      if (!nx) {
        alert("쿠콘 모듈이 준비되지 않았습니다.");
        return;
      }

      var certData = $("#cert_list option:selected").attr("data");
      if (!certData) {
        alert("인증서를 선택하세요.");
        return;
      }

      var cert = JSON.parse(certData);
      var certPwd = $("#cert_pwd").val();
      if (!certPwd) {
        alert("인증서 비밀번호를 입력하세요.");
        return;
      }

      var gigwan = $("#gigwan").val();
      if (!gigwan) {
        alert("금융기관을 선택하세요.");
        return;
      }

      var acctNo = $("#acct_no").val();
      var startDt = $("#start_dt").val();
      var endDt = $("#end_dt").val();

      var inputList = [];

      // 로그인
      inputList.push({
        Module: gigwan,
        Class: "개인뱅킹",
        Job: "로그인",
        Input: {
          로그인방식: "CERT",
          인증서: {
            이름: cert.RDN,
            비밀번호: certPwd
          }
        }
      });

      // 거래내역조회
      inputList.push({
        Module: gigwan,
        Class: "개인뱅킹",
        Job: "계좌거래내역조회",
        Input: {
          계좌번호: acctNo,
          조회시작일: startDt,
          조회종료일: endDt
        }
      });

      nx.execute(inputList, 0, function (results) {
        $("#acct_list").empty();

        for (var i = 0; i < results.length; i++) {
          var r = results[i];
          if (r.Job === "로그인") continue;

          var rec = r.Output && r.Output.Result && r.Output.Result["전계좌조회"];
          if (!rec) continue;

          var html = "<table><tr>" +
            "<th>예금명</th><th>계좌번호</th><th>잔액</th>" +
            "</tr>";

          for (var j = 0; j < rec.length; j++) {
            html += "<tr>" +
              "<td>" + (rec[j]["예금명"] || "") + "</td>" +
              "<td>" + (rec[j]["계좌번호"] || "") + "</td>" +
              "<td>" + (rec[j]["잔액"] || "") + "</td>" +
              "</tr>";
          }
          html += "</table><br/>";
          $("#acct_list").append(html);
        }
      });
    }
  </script>
</head>

<body>
  <div class="wrap">
    <div class="header_wrap">
      <h1 class="tit_h1">금융기관-계좌조회</h1>
    </div>

    <div class="content_wrap">
      <div class="tbl_lst">
        <table>
          <tbody>
            <tr>
              <th>인증서</th>
              <td><select id="cert_list"></select></td>
              <th>비밀번호</th>
              <td><input type="password" id="cert_pwd"></td>
            </tr>
            <tr>
              <th>금융기관</th>
              <td>
                <select id="gigwan">
                  <option value="">선택</option>
                  <option value="kbstar">국민은행</option>
                  <option value="shinhan">신한은행</option>
                  <option value="wooribank">우리은행</option>
                </select>
              </td>
              <th>계좌번호</th>
              <td><input type="text" id="acct_no"></td>
            </tr>
            <tr>
              <th>시작일</th>
              <td><input id="start_dt"></td>
              <th>종료일</th>
              <td><input id="end_dt"></td>
            </tr>
          </tbody>
        </table>

        <div style="margin-top:10px">
          <button onclick="doScrape()">조회</button>
        </div>
      </div>

      <div id="acct_list" style="margin-top:20px"></div>
    </div>
  </div>
</body>
</html>
